const models = require("../models/models");
const ApiError = require('../error/ApiError');
const { Op } = require('sequelize');

class KtdController {
    async getAll(req, res) {
        
        const result = await models.StudentsRating.findAll({
            
            attributes: ['id', 'destination'],
            order: [
                [ models.Students,  'sad', 'DESC NULLS LAST' ],
                [ models.Rating,  'points', 'DESC' ]
                
            ],
            required:true,
            include: [
                {
                    model: models.Students,attributes: ['studnumber','fullname','educationgroup','institute','sad'],
                },
                {
                    model: models.Rating,attributes: ['points'],
                    required:true,
                    include: [
                        {
                            model: models.RatingCourses,
                            required:true,
                            include: [
                                {
                                    model: models.Courses,
                                    
                                    where: {
                                        'title': 'КТД',
                                    }
                                },
                                {
                                    model: models.CourseLevels,attributes: ['level']
                                }
                            ]
                        }
                    ]
                },
                {
                    model: models.DateTable,
                    attributes: ['id','date'],
                    required:true,
                    where: {
                      'date': {
                          [Op.contains]: [
                            { value: new Date(), inclusive: true },
                            { value: new Date(), inclusive: true }
                            //{ value: new Date(Date.UTC(2022, 7, 1)), inclusive: true },
                            //{ value: new Date(Date.UTC(2023, 1, 31)), inclusive: true }
                          ]
                      }
                  },
                }
            ]
        });
        
        return res.json(result)
    }

}
module.exports = new KtdController()